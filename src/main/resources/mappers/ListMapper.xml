<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
        
<mapper namespace="july.lease.dao.list.ListMapper">

	<select id="getList" resultType="july.lease.dto.ListDto"> <!-- 판매중지가 된 물건리스트 조회 -->
		SELECT PRODUCT.PRODUCT_ID as productId, STORE_IMAGE_NAME as storeImageName, PRODUCT_NAME as productName, PRODUCT_PRICE as productPrice
		FROM PRODUCT
		
		<!-- 물품사진중 한개만가져옴 -->
		LEFT JOIN (
		    SELECT PRODUCT_ID, STORE_IMAGE_NAME, ROW_NUMBER() OVER (PARTITION BY PRODUCT_ID ORDER BY PRODUCT_IMAGE_ID) AS ROW_NUM
		    FROM PRODUCT_IMAGE
		) P_IMAGE ON (PRODUCT.PRODUCT_ID = P_IMAGE.PRODUCT_ID AND P_IMAGE.ROW_NUM = 1)
		
		<!-- 희망대여일에 대한 조건 -->
		<if test="startDate != '' or endDate != ''">
			JOIN (SELECT PRODUCT_ID, RENT_ABLE_START_DATE, RENT_ABLE_END_DATE
			        FROM RENT_DATE
			        WHERE TO_DATE(#{startDate}, 'YYYY-MM-DD') BETWEEN RENT_ABLE_START_DATE AND RENT_ABLE_END_DATE
			        	AND TO_DATE(#{endDate}, 'YYYY-MM-DD') BETWEEN RENT_ABLE_START_DATE AND RENT_ABLE_END_DATE
			        ) R ON (R.PRODUCT_ID = PRODUCT.PRODUCT_ID)
		</if>
			
		WHERE PRODUCT_END_STATUS = 'N' AND PRODUCT_NAME LIKE '%' || #{searchWord} || '%'
		
		<!-- 정렬조건 -->
		<if test="sort == 'popular'"> ORDER BY PRODUCT_VISIT_COUNT DESC </if>
		<if test="sort == 'recently'"> ORDER BY PRODUCT_CREATE_DATE </if>
		<if test="sort == 'rowPrice'"> ORDER BY PRODUCT_PRICE  </if>
		<if test="sort == 'highPrice'"> ORDER BY PRODUCT_PRICE DESC </if>
		
	</select>
	<select id="getListAJAX" resultType="july.lease.dto.ListDto"> <!-- 판매중지가 된 물건리스트 조회 -->
		SELECT productId, storeImageName, productName, productPrice
		FROM (
		    SELECT PRODUCT.PRODUCT_ID as productId, STORE_IMAGE_NAME as storeImageName, PRODUCT_NAME as productName, PRODUCT_PRICE as productPrice, 
		    		ROW_NUMBER() OVER (
		    		<if test="sort == 'popular'"> ORDER BY PRODUCT_VISIT_COUNT DESC </if>
					<if test="sort == 'recently'"> ORDER BY PRODUCT_CREATE_DATE </if>
					<if test="sort == 'rowPrice'"> ORDER BY PRODUCT_PRICE  </if>
					<if test="sort == 'highPrice'"> ORDER BY PRODUCT_PRICE DESC </if>
		    		) AS RNUM
		    FROM PRODUCT
			<!-- 물품사진중 한개만가져옴 -->
			LEFT JOIN (
			    SELECT PRODUCT_ID, STORE_IMAGE_NAME, ROW_NUMBER() OVER (PARTITION BY PRODUCT_ID ORDER BY PRODUCT_IMAGE_ID) AS ROW_NUM
			    FROM PRODUCT_IMAGE
			) P_IMAGE ON (PRODUCT.PRODUCT_ID = P_IMAGE.PRODUCT_ID AND P_IMAGE.ROW_NUM = 1)
			<!-- 희망대여일에 대한 조건 -->
			<if test="startDate != '' or endDate != ''">
			JOIN (SELECT PRODUCT_ID, RENT_ABLE_START_DATE, RENT_ABLE_END_DATE
			        FROM RENT_DATE
			        WHERE TO_DATE(#{startDate}, 'YYYY-MM-DD') BETWEEN RENT_ABLE_START_DATE AND RENT_ABLE_END_DATE
			        	AND TO_DATE(#{endDate}, 'YYYY-MM-DD') BETWEEN RENT_ABLE_START_DATE AND RENT_ABLE_END_DATE
			        ) R ON (R.PRODUCT_ID = PRODUCT.PRODUCT_ID)
			</if>
			WHERE PRODUCT_END_STATUS = 'N' AND PRODUCT_NAME LIKE '%' || #{searchWord} || '%'
			<!-- 정렬조건 -->
			<if test="sort == 'popular'"> ORDER BY PRODUCT_VISIT_COUNT DESC </if>
			<if test="sort == 'recently'"> ORDER BY PRODUCT_CREATE_DATE </if>
			<if test="sort == 'rowPrice'"> ORDER BY PRODUCT_PRICE  </if>
			<if test="sort == 'highPrice'"> ORDER BY PRODUCT_PRICE DESC </if>
		    ) A
		WHERE RNUM BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<select id="getCount" resultType="String">
	    SELECT count(product.product_id)
	    FROM PRODUCT
	    JOIN (SELECT PRODUCT_ID, RENT_ABLE_START_DATE, RENT_ABLE_END_DATE
	            FROM RENT_DATE
			        WHERE TO_DATE(#{startDate}, 'YYYY-MM-DD') BETWEEN RENT_ABLE_START_DATE AND RENT_ABLE_END_DATE
			        	AND TO_DATE(#{endDate}, 'YYYY-MM-DD') BETWEEN RENT_ABLE_START_DATE AND RENT_ABLE_END_DATE
	            ) R ON (R.PRODUCT_ID = PRODUCT.PRODUCT_ID)
	    WHERE PRODUCT_END_STATUS = 'N' AND PRODUCT_NAME LIKE '%' || #{searchWord} || '%'
	</select>
</mapper>     